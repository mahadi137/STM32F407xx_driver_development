/*
 * stm32f407xx_spi_driver.c
 *
 *  Created on: 28 Dec 2025
 *      Author: sayad hassan
 */



/*
 * Peripheral Clock setup
 */
void SPI_PeriClockControl(SPI_RegDef_t *pSPIx, uint8_t EnorDi)
{
	if (EnorDi == ENABLE)
	{
	    if (pSPIx == SPI1)      SPI1_PERI_CLK_EN();
	    else if (pSPIx == SPI2) SPI2_PERI_CLK_EN();
	    else if (pSPIx == SPI3) SPI3_PERI_CLK_EN();
	    else if (pSPIx == SPI4) SPI4_PERI_CLK_EN();
	}
	else
	{
		if (pSPIx == SPI1)      SPI1_PERI_CLK_DI();
		else if (pSPIx == SPI2) SPI2_PERI_CLK_DI();
		else if (pSPIx == SPI3) SPI3_PERI_CLK_DI();
		else if (pSPIx == SPI4) SPI4_PERI_CLK_DI();
	}
}



/*
 * Init and De-init
 */
void SPI_Init(SPI_Handle_t *pSPIHandle)
{
	//peripheral clock enable

	SPI_PeriClockControl(pSPIHandle->pSPIx, ENABLE);



	uint32_t temp = 0;

	// Configure the device mode
	temp |= (pSPIHandle->SPIPinConfig.DeviceMode << SPI_CR1_MSTR);


	// Configure the bus config
	if(pSPIHandle->SPIPinConfig.BusConfig == SPI_DEVICE_BUS_MODE_FD)
	{
		temp &= ~(1 << SPI_CR1_BIDIMODE);
		temp &= ~(1 << SPI_CR1_RXONLY);
	}
	else if(pSPIHandle->SPIPinConfig.BusConfig == SPI_DEVICE_BUS_MODE_HD)
	{
		temp |= (1 << SPI_CR1_BIDIMODE);
	}
	else if(pSPIHandle->SPIPinConfig.BusConfig == SPI_DEVICE_BUS_MODE_SIMPLEX_TXONLY)
	{
		temp |= (1 << SPI_CR1_BIDIOE);
	}
	else if(pSPIHandle->SPIPinConfig.BusConfig == SPI_DEVICE_BUS_MODE_SIMPLEX_RXONLY)
	{
		temp &= ~(1 << SPI_CR1_BIDIOE);
		temp |= (1 << SPI_CR1_RXONLY);
	}


	// Configure the CPHA
	temp |= (pSPIHandle->SPIPinConfig.CPHA << SPI_CR1_CPHA);

	// Configure the CPOL
	temp |= (pSPIHandle->SPIPinConfig.CPOL << SPI_CR1_CPOL);

	// Configure the DFF
	temp |= (pSPIHandle->SPIPinConfig.DFF << SPI_CR1_DFF);

	// configure the SSM
	temp |= (pSPIHandle->SPIPinConfig.SSM << SPI_SSM_EN);

	// Configure the spi serial clock speed (baud rate)
	temp |= (pSPIHandle->SPIPinConfig.BR << SPI_CR1_BR);



	pSPIHandle->pSPIx->CR1 = temp;

}


